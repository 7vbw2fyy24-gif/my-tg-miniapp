<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–∏ –ó–∞—è–≤–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #000000);
            --hint-color: var(--tg-theme-hint-color, #999999);
            --secondary-bg-color: var(--tg-theme-secondary-bg-color, #f4f4f4);
            --accent-color: var(--tg-theme-button-color, #31B545);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 15px;
        }
        .main-container {
            display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –ø–æ–∫–∞ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è */
        }
        .loader {
            text-align: center;
            padding-top: 50px;
            color: var(--hint-color);
        }
        .request-card {
            background-color: var(--secondary-bg-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .request-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .request-card-body {
            font-size: 14px;
            color: var(--hint-color);
        }
        .status {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        .status-pending { background-color: #f39c12; }
        .status-processing { background-color: #3498db; }
        .status-completed { background-color: #2ecc71; }
        .status-rejected { background-color: #e74c3c; }
        .status-cancelled { background-color: #95a5a6; }
        h2 {
            margin-top: 0;
        }
        .no-requests {
            text-align: center;
            color: var(--hint-color);
            padding: 40px 0;
        }
    </style>
</head>
<body>

    <div id="loader" class="loader">
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
    </div>

    <div id="main-container" class="main-container">
        <h2>–ú–æ–∏ –∑–∞—è–≤–∫–∏</h2>
        <div id="requests-list"></div>
    </div>

    <script>
        // üî• –í–ê–ñ–ù–û: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–¥–µ—Å—å —É–∫–∞–∑–∞–Ω –≤–∞—à –ê–ö–¢–£–ê–õ–¨–ù–´–ô URL –æ—Ç ngrok.
        // –û–Ω –ù–ï –¥–æ–ª–∂–µ–Ω –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –Ω–∞ —Å–ª—ç—à.
        const API_BASE_URL = "https://unvigilantly-unmicrobial-bianca.ngrok-free.dev";

        const tg = window.Telegram.WebApp;
        
        // --- –≠–ª–µ–º–µ–Ω—Ç—ã UI ---
        const loader = document.getElementById('loader');
        const mainContainer = document.getElementById('main-container');
        const requestsList = document.getElementById('requests-list');

        // --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö ---
        async function fetchAndDisplayData() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä, —Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
            loader.style.display = 'block';
            mainContainer.style.display = 'none';

            try {
                // --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ë–õ–û–ö ---
                // –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ –Ω–∞—à–µ–º—É API
                const response = await fetch(`${API_BASE_URL}/api/get_my_requests`, { ... });
                // –§–æ—Ä–º–∏—Ä—É–µ–º URL –±–µ–∑–æ–ø–∞—Å–Ω–æ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–≤–æ–π–Ω—ã—Ö –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö —Å–ª—ç—à–µ–π.
                // --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ì–û –ë–õ–û–ö–ê ---

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                displayRequests(data.requests);

            } catch (error) {
                console.error("Failed to fetch data:", error);
                requestsList.innerHTML = `<div class="no-requests"><p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.</p><p style="font-size: 12px; color: var(--hint-color)">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.</p></div>`;
            } finally {
                // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
                loader.style.display = 'none';
                mainContainer.style.display = 'block';
            }
        }
        
        // --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∑–∞—è–≤–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ---
        function displayRequests(requests) {
            if (!requests || requests.length === 0) {
                requestsList.innerHTML = `<div class="no-requests"><p>–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –∑–∞—è–≤–æ–∫.</p></div>`;
                return;
            }

            // –°–ª–æ–≤–∞—Ä—å –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
            const statusMap = {
                'pending': { text: '–í –æ—á–µ—Ä–µ–¥–∏', class: 'status-pending' },
                'processing': { text: '–í —Ä–∞–±–æ—Ç–µ', class: 'status-processing' },
                'completed': { text: '–ó–∞–≤–µ—Ä—à–µ–Ω–∞', class: 'status-completed' },
                'rejected': { text: '–û—Ç–∫–ª–æ–Ω–µ–Ω–∞', class: 'status-rejected' },
                'cancelled': { text: '–û—Ç–º–µ–Ω–µ–Ω–∞', class: 'status-cancelled' }
            };

            requestsList.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
            requests.forEach(req => {
                const statusInfo = statusMap[req.status] || { text: req.status, class: '' };
                const card = `
                    <div class="request-card">
                        <div class="request-card-header">
                            <span>–ó–∞—è–≤–∫–∞ #${req.id}</span>
                            <span class="status ${statusInfo.class}">${statusInfo.text}</span>
                        </div>
                        <div class="request-card-body">
                            <p>–ù–æ–º–µ—Ä: ${req.number}</p>
                            <p>–î–∞—Ç–∞: ${req.created_at}</p>
                        </div>
                    </div>
                `;
                requestsList.innerHTML += card;
            });
        }


        // --- –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ ---
        document.addEventListener('DOMContentLoaded', () => {
            tg.ready(); // –°–æ–æ–±—â–∞–µ–º Telegram, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ
            tg.expand(); // –†–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω

            // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö
            fetchAndDisplayData();
        });
    </script>

</body>
</html>

